<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <title>Pychess</title>
    <style>
        /* Reset e estilo geral */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f4f6f8;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
        }

        button {
            padding: 12px 24px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            background: #4CAF50;
            color: white;
            transition: 0.3s;
        }

        button:hover:enabled {
            background: #45a049;
        }

        button:disabled {
            background: #a5d6a7;
            cursor: not-allowed;
        }

        #controls {
            margin-bottom: 20px;
        }

        #turnDisplay {
            font-size: 18px;
            font-weight: 600;
            color: #555;
            margin-bottom: 20px;
        }

        #output {
            width: 100%;
            max-width: 500px;
            background: #fff;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0px 2px 10px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
            max-height: 300px;
        }

        #output ul {
            list-style: none;
        }

        #output li {
            margin: 8px 0;
            padding: 8px;
            border-radius: 8px;
        }

        .playerMove {
            background: #e0f7fa;
            color: #00796b;
        }

        .robotMove {
            background: #fff3e0;
            color: #e65100;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0px 4px 20px rgba(0, 0, 0, 0.2);
        }

        .modal-content h2 {
            margin-bottom: 15px;
            color: #333;
        }

        #tokenDisplay {
            background: #f4f6f8;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            margin-bottom: 20px;
            word-break: break-all;
        }
    </style>
</head>

<body>
    <h1>Pychess üéâ</h1>

    <div id="controls">
        <button onclick="playGame()">üéÆ Jogar</button>
        <button onclick="openModal()">ü§ñ Integra√ß√£o</button>
        <button id="passTurnBtn" onclick="passTurn()" disabled>‚û°Ô∏è Passar Vez</button>
    </div>

    <div id="turnDisplay">Aguardando in√≠cio do jogo...</div>

    <div id="output">
        <ul id="moveList"></ul>
    </div>

    <!-- Modal -->
    <div id="tokenModal" class="modal">
        <div class="modal-content">
            <h2>Token de Integra√ß√£o</h2>
            <p id="tokenDisplay">Gerando token...</p>
            <button onclick="closeModal()">Fechar</button>
        </div>
    </div>

    <script>
        let isPlayerTurn = false;
        const moveList = document.getElementById("moveList");

        async function playGame() {
            try {
                const response = await fetch("/start_game/", { method: "POST" });
                const data = await response.json();

                // Limpa hist√≥rico de jogadas
                moveList.innerHTML = "";

                // Quando o jogo inicia, a vez √© do jogador
                isPlayerTurn = true;
                updateTurnDisplay();
                toggleButton();

                addMoveToHistory("In√≠cio do jogo", "", "system");

            } catch (err) {
                alert("Erro ao iniciar o jogo: " + err);
            }
        }

        function updateTurnDisplay() {
            const turnText = isPlayerTurn ? "Sua vez! üéØ" : "Vez do Rob√¥ ü§ñ";
            document.getElementById("turnDisplay").innerText = turnText;
        }

        function toggleButton() {
            document.getElementById("passTurnBtn").disabled = !isPlayerTurn;
        }

        async function passTurn() {
            if (!isPlayerTurn) return;

            try {
                // Executa a jogada do humano + resposta do rob√¥
                const response = await fetch("/play_game/", { method: "POST" });
                const data = await response.json();

                // Adiciona jogadas ao hist√≥rico
                if (data.player_move) addMoveToHistory("Humano", data.player_move, "playerMove");
                if (data.stockfish_move) addMoveToHistory("Rob√¥", data.stockfish_move, "robotMove");

                // Depois de jogar, desabilita bot√£o at√© vez do humano
                isPlayerTurn = false;
                updateTurnDisplay();
                toggleButton();

                // Simula pequena espera do rob√¥ antes de voltar a vez
                setTimeout(() => {
                    isPlayerTurn = true;
                    updateTurnDisplay();
                    toggleButton();
                }, 500); // ajust√°vel

            } catch (err) {
                alert("Erro ao jogar: " + err);
            }
        }

        function addMoveToHistory(player, move, cssClass) {
            const li = document.createElement("li");
            li.textContent = player ? `${player}: ${move}` : move;
            if (cssClass) li.classList.add(cssClass);
            moveList.appendChild(li);
            moveList.scrollTop = moveList.scrollHeight;
        }

        async function openModal() {
            document.getElementById("tokenModal").style.display = "flex";
            document.getElementById("tokenDisplay").innerText = "Gerando token...";

            try {
                const response = await fetch("/generate-robo-token/", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                });
                const data = await response.json();

                // Mostra o token se existir, sen√£o mostra a mensagem
                if (data.token) {
                    document.getElementById("tokenDisplay").innerText = data.token;
                } else {
                    console.log(data)
                    document.getElementById("tokenDisplay").innerText = data.message;
                }
            } catch (err) {
                document.getElementById("tokenDisplay").innerText = "Erro ao gerar token!";
                console.error(err);
            }
        }

        function closeModal() {
            document.getElementById("tokenModal").style.display = "none";
        }
    </script>
</body>

</html>